{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card d-flex justify-content-between align-items-center">
            <div>
                <h4 class="text-white mb-0"><i class="fas fa-chart-pie text-neon me-2"></i>Performance Analytics</h4>
                <small class="text-white-50">Historical Analysis & Impact Assessment</small>
            </div>
            <button class="btn btn-sm btn-outline-light"><i class="fas fa-download me-2"></i>Export Report</button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-8">
        <div class="glass-card h-100">
            <h5 class="text-white mb-4">Weekly Revenue Trend (AI Impact)</h5>
            <div style="height: 300px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="glass-card h-100">
            <h5 class="text-white mb-4">Conversion by Zone</h5>
            <div style="height: 300px;">
                <canvas id="zoneChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="glass-card">
            <h5 class="text-white mb-3">Raw Performance Metrics</h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0" style="background: transparent;">
                    <thead>
                        <tr class="text-white-50 small text-uppercase">
                            <th>Zone Name</th>
                            <th>Visitors</th>
                            <th>Dwell Time</th>
                            <th>Conversion</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in analytics_data %}
                        <tr>
                            <td class="text-neon fw-bold">{{ row.Zone_Name }}</td>
                            <td>{{ row.Visitors }}</td>
                            <td>{{ row.Avg_Dwell_Time }}s</td>
                            <td>{{ row.Conversion_Rate }}%</td>
                            <td class="text-success">${{ row.Revenue }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- GLOBAL CHART INSTANCES ---
    let revenueChart = null;
    let zoneChart = null;

    // --- DATA PASSING ---
    const dates = {{ dates | safe }};
    const revenues = {{ revenues | safe }};
    const zoneNames = {{ zone_names | safe }};
    const conversions = {{ conversions | safe }};

    // --- THEME PALETTES ---
    const THEMES = {
        dark: {
            text: '#94a3b8',
            grid: 'rgba(255, 255, 255, 0.05)',
            lineColor: '#d4af37', // Gold
            fillStart: 'rgba(212, 175, 55, 0.4)',
            fillEnd: 'rgba(212, 175, 55, 0.0)'
        },
        light: {
            text: '#64748b',
            grid: 'rgba(0, 0, 0, 0.05)',
            lineColor: '#21867a', // Teal
            fillStart: 'rgba(42, 157, 143, 0.3)',
            fillEnd: 'rgba(42, 157, 143, 0.0)'
        }
    };

    function getThemeConfig() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        return THEMES[currentTheme];
    }

    // --- CHART CREATION FUNCTION ---
    function initCharts() {
        const theme = getThemeConfig();
        const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
        const ctxZone = document.getElementById('zoneChart').getContext('2d');

        // Destroy existing if re-initializing
        if (revenueChart) revenueChart.destroy();
        if (zoneChart) zoneChart.destroy();

        // 1. REVENUE CHART
        let gradientRev = ctxRevenue.createLinearGradient(0, 0, 0, 400);
        gradientRev.addColorStop(0, theme.fillStart);
        gradientRev.addColorStop(1, theme.fillEnd);

        revenueChart = new Chart(ctxRevenue, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Revenue (â‚¹)',
                    data: revenues,
                    borderColor: theme.lineColor,
                    backgroundColor: gradientRev,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointRadius: 4,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        grid: { color: theme.grid },
                        ticks: { color: theme.text }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: theme.text }
                    }
                }
            }
        });

        // 2. ZONE CHART
        zoneChart = new Chart(ctxZone, {
            type: 'bar',
            data: {
                labels: zoneNames,
                datasets: [{
                    label: 'Conversion Rate (%)',
                    data: conversions,
                    backgroundColor: [
                        'rgba(212, 175, 55, 0.8)',  // Gold
                        'rgba(42, 157, 143, 0.8)',  // Teal
                        'rgba(231, 111, 81, 0.8)',  // Orange
                        'rgba(233, 196, 106, 0.8)'   // Yellow
                    ],
                    borderRadius: 5,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        grid: { color: theme.grid },
                        ticks: { color: theme.text }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: theme.text }
                    }
                }
            }
        });
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', initCharts);

    // --- EVENT LISTENER FOR THEME SWITCH ---
    document.addEventListener('themeChanged', (e) => {
        // e.detail contains 'light' or 'dark'
        initCharts(); // Re-render with new theme colors
    });
</script>
{% endblock %}