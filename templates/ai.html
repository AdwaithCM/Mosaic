{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card d-flex justify-content-between align-items-center">
            <div>
                <h4 class="text-white mb-0"><i class="fas fa-brain text-neon me-2"></i>SPECTRE Neural Engine</h4>
                <small class="text-white-50">Status: <span class="text-success">‚óè
                        Online</span></small>
            </div>
            <button id="syncBtn" class="btn btn-outline-info btn-sm rounded-pill px-4 mx-3" onclick="runAI()">
                <i class="fas fa-sync-alt me-2"></i> Run Live Analysis

            </button>
            <div class="text-end">
                <button id="run-ai-btn" class="btn btn-outline-warning btn-sm" onclick="runAI()">
                    <i class="fas fa-sync-alt me-1"></i> Recalibrate Now
                </button>
            </div>

            <div class="text-end">
                <small class="text-white-50 d-block">Last Analysis</small>
                <span class="text-neon">{{ strategies[0].timestamp[11:16] if strategies else 'N/A' }}</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    {% if not strategies %}
    <div class="col-12">
        <div class="alert alert-danger">System Offline. Run Intelligence Engine.</div>
    </div>
    {% else %}

    <div class="col-12">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;">
            {% for strat in strategies %}
            <div class="glass-card h-100 position-relative"
                style="border-top: 4px solid {% if strat.ai_analysis.priority == 'High' %}#ff4d4d{% elif strat.ai_analysis.priority == 'Medium' %}#ffcc00{% else %}#00ff9d{% endif %};">

                <span class="position-absolute top-0 end-0 badge rounded-pill m-3"
                    style="background: {% if strat.ai_analysis.priority == 'High' %}rgba(255, 77, 77, 0.2); color: #ff4d4d; border: 1px solid #ff4d4d{% elif strat.ai_analysis.priority == 'Medium' %}rgba(255, 204, 0, 0.2); color: #ffcc00; border: 1px solid #ffcc00{% else %}rgba(0, 255, 157, 0.2); color: #00ff9d; border: 1px solid #00ff9d{% endif %};">
                    {{ strat.ai_analysis.priority }}
                </span>

                <h5 class="text-white mb-1">{{ strat.zone }}</h5>
                <span class="badge bg-secondary mb-3">{{ strat.ai_analysis.category }}</span>

                <div class="mb-3">
                    <h6 class="text-white-50 small"><i class="fas fa-search text-info me-1"></i> Insight</h6>
                    <p class="text-light small">{{ strat.ai_analysis.diagnosis }}</p>
                </div>

                <div class="mb-3">
                    <h6 class="text-white-50 small"><i class="fas fa-bolt text-warning me-1"></i> Action</h6>
                    <p class="text-white small fw-bold">{{ strat.ai_analysis.action_plan }}</p>
                </div>

                <button type="button" class="btn btn-sm btn-outline-info w-100 mt-auto" data-bs-toggle="modal"
                    data-bs-target="#modal-{{ loop.index }}">
                    <i class="fas fa-file-alt me-2"></i> View Detailed Report
                </button>

            </div>

            <div class="modal fade" id="modal-{{ loop.index }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content" style="background: #1a1a2e; border: 1px solid #00f2ff; color: white;">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title text-neon">{{ strat.zone }} Strategic Report</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <h6 class="text-muted text-uppercase small">Current Metrics</h6>
                            <div class="d-flex gap-3 mb-3">
                                <span class="badge bg-dark border border-secondary">Visitors: {{
                                    strat.metrics_snapshot.visitors }}</span>
                                <span class="badge bg-dark border border-secondary">Conv: {{
                                    strat.metrics_snapshot.conversion }}%</span>
                            </div>

                            <h6 class="text-muted text-uppercase small">AI Analysis</h6>
                            <p class="small" style="line-height: 1.8;">
                                {{ strat.ai_analysis.detailed_report }}
                            </p>

                            <div class="alert alert-success d-flex align-items-center mt-3"
                                style="background: rgba(25, 135, 84, 0.2); border: 1px solid #198754; color: #75b798;">
                                <i class="fas fa-rocket me-2"></i>
                                <div>
                                    <strong>Projected Outcome:</strong> {{ strat.ai_analysis.expected_outcome }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
<script>
    function runAI() {
        const btn = document.getElementById('syncBtn');
        const originalText = btn.innerHTML;

        // 1. Change button to loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Analyzing...';
        btn.disabled = true;

        // 2. Call Python Route
        fetch('/run_intelligence', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 3. If success, reload page to see new data
                    location.reload();
                } else {
                    alert("Error: " + data.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Server Connection Failed");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }
</script>
{% endblock %}